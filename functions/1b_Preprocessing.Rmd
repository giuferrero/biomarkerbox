---
title: "Report: Data Preprocessing"
output: 
  pdf_document:
    latex_engine: pdflatex
  html_document:
    toc: true
    toc_float: true
    code_folding: show
always_allow_html: yes
params:
  outfolder: ""
  pdata: ""
  cdata: ""
  covclass: ""
  refcov: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

In this document are reported the preprocessing analyses of the sample and the count table.

```{r reading, echo=FALSE, message=FALSE, warning=FALSE}
# Output folder creation
outf = paste0(params$outfolder, "/01_QC_and_Data_Preprocessing/")
dir.create("01_QC_and_Data_Preprocessing")

# Table containing the covariates
phenoData <- read.delim(params$pdata, row.names=1, check.names = F)

# Table containing the count data
countData <- read.delim(params$cdata, row.names=1, check.names = F)

# List reporting the class of each sample attribute
covariates <- read.delim(params$covclass)

# Identification of the levels of the reference covariate
refcov <- params$refcov
cov_class <- levels(phenoData[,refcov])
```

```{r compade, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# Check reference attribute
if(refcov %in% names(phenoData)){
  cat(paste0("The ", refcov, " attribute is included in the sample attributes.\n\n"), sep="")}else{
  cat(paste0("The ", refcov, " attribute is not included in the sample attributes.\n\n"))
  stop("Exiting")}
```

```{r setclass, echo=FALSE, message=FALSE, warning=FALSE} 
#### Defining the class of the sample attribute
  for(i in 1:ncol(phenoData)){
    if(as.character(covariates[,2][i]) == "factor"){
      phenoData[, i] = as.factor(phenoData[, i])}
    else{
      class(phenoData[, i]) = as.character(covariates[,2][i])}
  }
```

```{r setup, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
# Loading of the packages
knitr::opts_chunk$set(echo = TRUE)
library("dplyr")
library("ggplot2")
```

## Description of the datasets
The sample table stored in the **`r basename(params$pdata)`** file has **`r ncol(phenoData)`** attributes for **`r nrow(phenoData)`** samples.

The count table stored in the **`r basename(params$cdata)`** file has **`r nrow(countData)`** attributes for **`r ncol(countData)`** samples.

The reference sample attribute is **`r refcov`**. The reference attribute is divided in **`r length(cov_class)`** classes.

## Check for normal distribution
The distribution of the numeric attributes of the sample table were checked for normality using the Shapiro-Wilk test.

```{r norm, echo=FALSE, message=FALSE, warning=FALSE}
# Isolation of the numeric sample attributes
phenoData_num <- phenoData[,unlist(lapply(phenoData, is.numeric))]
phenoData_num <- phenoData_num %>% select_if(~ length(unique(.)) > 1)

# Shapiro-Wilk test to verify the normality distribution of each attribute
resnorm <- unlist(mapply(shapiro.test, phenoData_num)["p.value",])

# Analysis of the normality test results
if(sum(resnorm > 0.05) == 0){
  outnorm <- "\nNone attribute of the sample table is normally distributed."}else{
  Normcolp <- names(phenoData_num)[resnorm > 0.05]  
  outnorm <- paste0("\nThe following attribute(s) of the sample table is(are) normally distributed:\n", paste(Normcolp, collapse=", "), sep="\n")}

outhead <- "Preprocessing report: Normal distribution analysis\n"

# Write of the output file
write.table(paste0(outhead, outnorm), paste0(outf, "Preprocessing_Table_Normal_distribution.txt"), quote=F, row.names=F, col.names=F, sep="\t")
```
`r outnorm`

An output file named **QC_Table_Normal_distribution.txt** is provided with the summary of this analysis. 

## Check for outliers
The numerical variables of the sample table were checked for possible outliers.
```{r chechoutlier, echo=FALSE, message=FALSE, warning=FALSE}
out <<- "Preprocessing report: Outliers analysis\n\n"
outlier_attr <- c()

# Definition of a function to identify the outliers
outlier_find <- function(dt, var) {
  tot <- sum(!is.na(dt[,var]))
  na1 <- sum(is.na(dt[,var]))
  m1 <- mean(dt[,var], na.rm = T)
  med <- median(dt[,var], na.rm = T)
  outlier <- boxplot.stats(dt[,var])$out
  dt2 <- dt
  dt2[,var] <- ifelse(dt[,var] %in% outlier, NA, dt[,var])
  na2 <- sum(is.na(dt2[,var]))
  m2 <- mean(dt2[,var], na.rm = T)
  
  if(length(outlier > 0)){
  outlier_attr <<- c(outlier_attr, var)
  out <<- paste0(out, "The sample attribute \"", var, "\" presents outliers.",
  "\nOutliers identified: ", na2 - na1, " from ", tot, " observations\n",
  "\nMean with outliers: ", round(m1,3),
  "\nMean without outliers: ", round(m2,3), 
  "\nMedian without outliers: ", round(med,3), "\n\n") } else{
  out <<- paste0(out, "The sample attribute ", var, " does not present an outlier.\n\n")
  }}

# Application of the function on each numerical attributes
for(i in 1:ncol(phenoData_num)){
  outlier_find(phenoData_num, names(phenoData_num)[i])}

if(length(outlier_attr)){
    outoutlier <- paste0("The following sample attribute(s) present at least one outlier:\n", paste(outlier_attr, collapse=", "))
}else{outoutlier <- paste0("None sample attributes present at least one outlier.")}

# Write of the output file
write.table(out, paste0(outf,"Preprocessing_Table_Outlier_analysis.txt"), quote=F, row.names=F, col.names=F, sep="\t")
```
`r outoutlier`

```{r outlierplot, echo=FALSE, message=FALSE, warning=FALSE}
l <- list()
# For attributes with outliers report of their distribution
if(length(outlier_attr)>0){
for(i in 1:length(outlier_attr)){
  var <- outlier_attr[i]
  
  p <- ggplot(phenoData_num, aes(x = phenoData_num[,var])) + geom_density(colour="black", fill="white", alpha=0.8) + geom_rug(alpha=0.05) + theme_bw() + labs(x=var) + ggtitle(paste0("Distribution of the ", var, " attribute"))
  
  pdf(paste0(outf,"Preprocessing_Plot_Outlier_analysis_histogram_", var, ".pdf"))
  print(p)
  dev.off()
}}
```

An output file named **Preprocessing_Table_Outlier_analysis.txt** is provided reporting, if present, the outlier values identified with computation of the mean of each attribute with or without outliers. If present, for each attribute presenting an outlier, an histogram plot names **Preprocessing_Plot_Outlier_analysis_histogram_(attribute).pdf** (attribute = identifier of the attribute considered) was provided.

## Analysis of batch effect on the data
The count table was verified for candidate batch effects using SVA.
```{r sva, echo=FALSE, message=FALSE, warning=FALSE}

```

## Output files
The following output files were generated:

* Preprocessing_Table_Normal_distribution_analysis.txt
* Preprocessing_Table_Outlier_analysis.txt
* Preprocessing_Plot_Outlier_analysis_histogram_(attribute).pdf (attribute = identifier of the attribute considered)

All the output files were generated in the folder **01_QC_and_Data_Preprocessing**